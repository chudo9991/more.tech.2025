name: Simple VPS Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Deploy to VPS
      run: |
        echo "üöÄ Deploying to VPS server..."
        
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          echo "üìÅ Creating project directory..."
          mkdir -p /opt/interview-ai
          cd /opt/interview-ai
          
          echo "üõë Stopping existing containers..."
          docker compose -f docker-compose.yml down || true
          
          echo "üì• Cloning repository..."
          rm -rf more.tech.2025
          git clone https://github.com/${{ github.repository }}.git more.tech.2025
          cd more.tech.2025
          
          echo "üîß Building and starting services..."
          docker compose -f docker-compose.yml build
          docker compose -f docker-compose.yml up -d
          
          echo "‚è≥ Waiting for services to start..."
          sleep 30
          
          echo "‚úÖ Checking service status..."
          docker compose -f docker-compose.yml ps
          
          echo "üîÑ Checking database migrations..."
          docker compose -f docker-compose.yml exec -T orchestrator alembic current || echo "‚ö†Ô∏è  Could not check migrations"
          
          echo "üåê Testing application..."
          curl -f http://localhost:80 || echo "‚ö†Ô∏è  Application not responding on port 80"
        EOF
        
    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        sleep 10
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        curl -f https://moretech2025clvb.ru || echo "‚ö†Ô∏è  HTTPS not responding"
        curl -f http://moretech2025clvb.ru || echo "‚ö†Ô∏è  HTTP not responding"
        
    - name: Deployment summary
      run: |
        echo "üéâ Deployment completed!"
        echo "üåê Application URL: https://moretech2025clvb.ru"
        echo "üìä Server IP: ${{ secrets.SERVER_HOST }}"
        echo "üìù Commit: ${{ github.sha }}"
