# Общие правила выполнения (выполнять на каждом шаге)

**R1. Проверка соответствия плану**

* Сверь текущую задачу с идентификатором из плана (T-ID) и фазой (D0…D3).
* Сопоставь ожидаемые артефакты шага с фактическими (diff по репо).
* Если обнаружено отклонение — зафиксируй его в `CHANGELOG.md` и в описании PR, вернись к требуемым артефактам.

**R2. Проверка качества кода (обязательные гейты)**

* Линтеры: `ruff`/`black`/`isort` (Python), `eslint`/`prettier` (frontend).
* Типизация: `mypy --strict` для Python (минимум на сервисах orchestrator, scoring).
* Тесты: `pytest -q` / `vitest` (или jest), покрытие не ниже **65%** для MVP-сервисов.
* Статический анализ/аудит зависимостей: `pip-audit`, `npm audit --audit-level=high`.
* Docker: multi-stage build, non-root user, образ < 400MB для Python-сервисов.
* OpenAPI: автогенерация и фиксация схемы (`/openapi.json`) в `api/snapshots/`.
* CI: пайплайн с этапами **lint → test → build → scan** должен быть зелёным.

**R3. Проверка соответствия задачи**

* Для каждого эндпоинта: есть Swagger-описание, пример запроса/ответа и тест(ы), покрывающие happy-path и один негативный сценарий.
* Артефакты шага (например, миграции, сиды, мок-сервер, диаграмма) присутствуют в заявленных путях.
* В `README.md` обновлена секция «Как проверить шаг» (команды make/URL).

**R4. Безопасность/конфиденциальность**

* Секреты только через `.env`/Docker secrets; в репо — только `.env.sample`.
* Логи без PII; аудио — через **presigned URL** (TTL ≤ 15 минут).
* В интро-скрипте звонка — голосовое согласие на запись.
* Лимиты/таймауты/ретраи с экспоненциальным бэкоффом у всех внешних вызовов.

**R5. Трассировка и наблюдаемость**

* Корреляция по `X-Request-ID`; структурные логи (JSON).
* Метрики: latency STT/LLM/TTS, end-to-report; health-checks `GET /healthz`.

**R6. Коммиты/PR**

* Ветка `feature/T-XX-*`, коммиты по Conventional Commits, PR с чек-листом R1–R3.

---

# Шаблон шага (применять ко всем задачам)

**Цель:** …
**Входы:** …
**Выходы/артефакты:** …
**Скрипт проверки:** команды `make …` / curl / URL
**Self-check (план):** указать T-ID, сравнить артефакты с ожиданиями
**Code-quality check:** линтеры, типизация, тесты, аудит, Docker
**Task-fit check:** контракт API, примеры, тесты соответствуют описанию
**DoD:** конкретные измеримые критерии

---

# Фаза D0 — Бутстрап

## T-01. Репозиторий и Compose-каркас

* **Цель:** моно-репо с сервисами: `orchestrator`, `stt`, `tts`, `scoring`, `frontend`, `db`, `minio`.
* **Артефакты:** `docker-compose.yml`, Dockerfile’ы, `.env.sample`, `Makefile`, `README.md`.
* **Скрипт проверки:** `make up`, затем `curl :8000/healthz`, `curl :8100/healthz` … по всем сервисам.
* **DoD:** все контейнеры стартуют; healthz=200; образы < 400MB (py-сервисы).

## T-02. Postgres и миграции

* **Артефакты:** Alembic-миграции для таблиц: `candidates, vacancies, questions, vacancy_questions, criteria, question_criteria, sessions, qa, qa_scores, media`.
* **Проверка:** `alembic upgrade head`; схемы видны; FK/PK корректны.
* **DoD:** `alembic downgrade/upgrade` идемпотентны; снапшот ER-диаграммы в `docs/`.

## T-03. Сид-данные демо

* **Артефакты:** `seeds/` (1 вакансия, 6–8 вопросов, критерии с весами и must\_have).
* **Проверка:** `make seed`; выборки возвращают ≥1 запись по всем сущностям.
* **DoD:** готов JSON-сценарий и критерии для LLM.

---

# Фаза D1 — Ядро интервью

## T-10. Orchestrator: сессии и шаги

* **Артефакты:** эндпоинты

  * `POST /sessions` → `session_id`
  * `POST /sessions/{id}/next` → `{question_id, question_text}`
  * `POST /sessions/{id}/answer` (question\_id, audio\_url)
  * `GET /sessions/{id}` → прогресс/итоги
    OpenAPI + тесты.
* **Проверка:** Postman-коллекция или `make demo_local` проходит happy-path.
* **DoD:** идемпотентность, сохранение состояния шага, unit-тесты ≥ 65%.

## T-11. SIP-вебхуки и симулятор провайдера

* **Артефакты:** `POST /webhooks/call` (start/record\_ready/end), CLI-симулятор, загрузка WAV в MinIO, генерация presigned URL.
* **Проверка:** `make simulate_call` → в БД создаётся `session`, в `media` — запись ответа.
* **DoD:** защита от дублей по `Idempotency-Key`, логи с `request_id`.

## T-12. STT + VAD

* **Артефакты:** `POST /stt/transcribe {audio_url, lang}` → `{text, segments[], pre_answer_pause_s, speech_rate_wpm}`; шумоподавление, VAD (webrtcvad).
* **Проверка:** на 10 тест-аудио WER ≤ 18%; корректная пауза перед ответом.
* **DoD:** обработка 8–16 кГц; таймаут 60с; негативный тест (пустое аудио).

## T-13. TTS + кэш

* **Артефакты:** `POST /tts/synthesize {text, voice}` → `{audio_url, duration_ms}`; LRU-кэш по (text, voice).
* **Проверка:** два одинаковых запроса → один и тот же URL; латентность < 1.5с.
* **DoD:** предгенерация вопросов при старте сессии; presigned URL.

## T-14. Scoring (LLM) — строгий JSON

* **Артефакты:** `POST /score` (вход: вопрос, ответ, `criteria[]`) → валидный JSON по схеме; JSON-валидация + «repair pass».
* **Проверка:** контрактные тесты (pydantic/jsonschema), негативный кейс (LLM вернул мусор) → ретрай и валидный результат.
* **DoD:** температура ≤ 0.2; логируются `explanations` и цитаты (evidence).

## T-15. Tone & паралингвистика

* **Артефакты:** `POST /nlp/tone {text}` → `{tone, confidence}`; агрегаты паралингвистики из STT.
* **Проверка:** детерминированность на одинаковом тексте; не влияет на итог без явной настройки.
* **DoD:** фича-флаг «учитывать паралингвистику в скоринге» = off по умолчанию.

## T-16. Сохранение результатов и агрегация

* **Артефакты:** запись `qa`, `qa_scores`, `media`; перерасчёт `sessions.total_score` по формуле весов (вопрос×критерий×оценка); ранний фейл по must\_have.
* **Проверка:** e2e: ответ не проходит must\_have → интервью вежливо завершается.
* **DoD:** SQL-вью для итогового отчёта по сессии.

---

# Фаза D2 — HR-панель и отчёты

## T-20. Список сессий

* **Артефакты:** таблица, фильтры, статус, итоговый скор, флаги.
* **Проверка:** данные из сидов и из реальной сессии отображаются.
* **DoD:** пагинация; сортировка; спиннеры/ошибки UX.

## T-21. Карточка кандидата

* **Артефакты:** транскрипты, роза ветров, баллы по критериям, ссылки на аудио.
* **Проверка:** клики по аудио работают (presigned URL), диаграммы корректны.
* **DoD:** загрузка lazy; не блокирует UI при долгих запросах.

## T-22. Переоценка (manual review)

* **Артефакты:** `POST /hr/qa/{id}/review` с `per_criterion_override[]`; аудит-лог.
* **Проверка:** общий скор пересчитан; в истории видно «кто/когда/что».
* **DoD:** фича-флаг; вендор-лок зависимостей отсутствует.

## T-23. Экспорт PDF/CSV

* **Артефакты:** PDF с диаграммой и таблицами; CSV с per-criterion баллами.
* **Проверка:** кнопки экспортов отдают файлы; верстка PDF не «прыгает».
* **DoD:** локаль ru-RU; корректные разделители десятичной части.

---

# Фаза D3 — Качество, приватность, демо

## T-30. Наблюдаемость

* **Артефакты:** Sentry, метрики (Prometheus/StatsD), дашборд latency и end-to-report.
* **Проверка:** протоколируется `request_id`, виден трейс звонка.
* **DoD:** алерты по SLA: STT/LLM/TTS > p95 3с → предупреждение.

## T-31. Приватность/Безопасность

* **Артефакты:** маскирование PII в логах; политики TTL аудио (напр., 30 дней); RBAC (HR/Admin).
* **Проверка:** ссылки на аудио истекают; PII не попадает в логи/ошибки.
* **DoD:** интро с голосовым согласием; политика удаления по запросу.

## T-32. E2E демо-скрипт

* **Артефакты:** `make demo` — имитация звонка до отчёта.
* **Проверка:** итог ≤ 2 минут после завершения интервью.
* **DoD:** демо стабильно повторяемо (3 прогона подряд без сбоев).

---

# Дополнительные обязательные требования (важно)

* **Версионирование промптов LLM**: хранить в `prompts/`, семантические версии, «golden tests» на фикстурах.
* **Стабильность контрактов**: OpenAPI contract tests; любое изменение — через `api/CHANGELOG.md`.
* **Производительность**: параллельная прегенерация TTS для следующего вопроса; конвейерная обработка STT→LLM.
* **Ресурсы**: ограничить CPU/RAM контейнеров; не грузить GPU (если не надо).
* **Лицензии**: файл `LICENSE`, у зависимостей без спорных лицензий — список в `THIRD_PARTY_NOTICES.md`.
* **Документация**: короткие рецепты в `README.md`: «как поднять», «как прогнать тесты», «как проверить шаг».
