# 0) Кратко

**Что строим:** телефонный AI-ассистент для первичного интервью.
**Как работает:** звонок → TTS задаёт вопрос → ответ в STT → LLM оценивает по критериям вопроса (JSON) + тон/паралингвистика → всё пишем в БД → HR-панель показывает «розу ветров» и отчёт.
**Схема архитектурного решения:** https://drive.google.com/file/d/1a6DyxuXplT28aZHZiIQxpxT4ccRJWELE/view?usp=sharing

---

# 1) Цели и границы MVP

* Провести **полноценное интервью** по 1 вакансии (6–8 вопросов).
* Поддержать **входящий или исходящий** звонок через SIP-провайдера (Mango/Zadarma).
* Получить **структурированный результат**: per-criterion баллы, общий скор, «must-have» решение, тон, поведенческие признаки, ключевые цитаты, ссылка на аудио.
* **Админка HR:** список сессий, карточка кандидата, «роза ветров», переоценка ответов.
* **Сроки:** хакатонная версия — без сложной саморегистрации и многоязычия.

**Вне MVP:** интеграции с ATS/CRM, календари, массовые рассылки, авто-перезвоны, сложные роли/доступы.

---

# 2) Архитектура и модули

1. **SIP-интеграция**

   * Провайдер: Mango/Zadarma.
   * События: звонок/ответ/завершение → **webhook** в Orchestrator.
   * Проигрывание аудио по URL, запись ответа в WAV/OGG.

2. **Orchestrator (FastAPI)**

   * Ведёт сценарий, хранит состояние шага, маршрутизирует аудио/текст.
   * Правила окончания ответа: **VAD по паузе 1.8–2.2 c + таймаут 60 c + стоп-слова**.
   * Ранний «фейл» при невыполнении **must-have**.

3. **STT** — Whisper (узкополосная телефония, 8 кГц)

   * Батч/стрим режимы (для MVP — батч).
   * VAD: webrtcvad/whisperx; шумоподавление.

4. **TTS** — Orpheus/Coqui/xtts

   * Кэширование аудио вопросов (чтобы не платить повторно).
   * Пресайнд-URL для провайдера.

5. **LLM-оценка**

   * Вход: {vacancy\_id, question\_id, question, answer\_text, **criteria\[]**}.
   * Выход: **строго по схеме JSON** (скор per-criterion, overall, evidence, red\_flags, passed).
   * JSON-валидация + авто-ремонт ответа (1 ретрай).
   * Температура 0–0.2, system-prompt с формальным контрактом.

6. **Tone & Паралингвистика**

   * Tone: positive/neutral/negative + confidence.
   * Параметры: средний темп (wpm), доля пауз, пауза перед ответом, длительность ответа.
   * *Важно:* эти признаки **информативны**, но не влияют на итог без явной настройки.

7. **Хранилище**

   * **Postgres** для сущностей и оценок; **S3/MinIO** для аудио.
   * Индексы по session/vacancy, GIN по JSONB (если выберем JSON-схему).

8. **HR-frontend (Vue/React)**

   * Список сессий, фильтры, карточка кандидата, «роза ветров», переоценка, экспорт.

9. **Наблюдаемость и SRE**

   * Логи (структурированные), Sentry, базовые метрики (latency STT/LLM/TTS, ASR-WER на эталонах), алерты.

---

# 3) Контракты (важно для интеграции)

## 3.1. Запрос в LLM-оценку

```json
{
  "vacancy_id": "SWE_BACK_001",
  "question_id": "Q_FASTAPI_01",
  "question": "Расскажите про опыт с FastAPI.",
  "answer_text": "… транскрипт …",
  "criteria": [
    {"id":"FASTAPI","weight":0.5,"must_have":true,"min_score":0.7},
    {"id":"ASYNCIO","weight":0.3},
    {"id":"TESTING","weight":0.2}
  ],
  "rubric_version": "v1"
}
```

## 3.2. Ответ LLM-оценки (валидация обязательна)

```json
{
  "overall_score": 0.78,
  "passed": true,
  "per_criterion": [
    {"id":"FASTAPI","score":0.9,"evidence":"упомянул Depends/BackgroundTasks"},
    {"id":"ASYNCIO","score":0.6},
    {"id":"TESTING","score":0.7}
  ],
  "red_flags": ["нет примеров нагрузочного тестирования"],
  "explanations": ["кандидат дал примеры роутинга, зависимостей"],
  "version": "v1"
}
```

## 3.3. Tone/Паралингвистика

```json
{
  "tone": "neutral",
  "confidence": 0.84,
  "paraling": {
    "answer_duration_s": 23.1,
    "pre_answer_pause_s": 0.8,
    "avg_silence_ratio": 0.22,
    "speech_rate_wpm": 130
  }
}
```

---

# 4) Data Flow (операционный)

1. Webhook «вызов» → создать `session`.
2. `TTS(question)` → аудио-URL → провайдер проигрывает.
3. Провайдер пишет ответ → Orchestrator → STT (VAD/таймаут) → текст.
4. Orchestrator → LLM (с критериями вопроса) + Tone/Паралингвистика.
5. Сохранить `qa`, `qa_scores`, `tone/paraling`, `media`.
6. Проверить must-have: при провале завершить интервью вежливым TTS.
7. На завершении — агрегировать `total_score`, сгенерить summary.

---

# 5) User Journey

**Кандидат:** получает звонок → слушает приветствие → отвечает на 6–8 вопросов → слышит завершение. Никаких установок/браузера.

**HR/аналитик:** открывает панель → видит список сессий и итоговые баллы → заходит в карточку → читает транскрипты, смотрит «розу ветров», ключевые цитаты и флаги → при необходимости переоценивает → принимает решение/экспортирует отчёт.

---

# 6) Оптимизации (сразу заложить)

* **Кэш TTS**: одинаковые вопросы → одна аудиозаготовка (до −90% TTS-запросов).
* **Буферизация STT**: резка по VAD с оверлапом 200–300 мс → меньше WER.
* **Жёсткие таймауты**: STT/LLM/TTS с ретраями и деградацией (короткая модель, упрощённый prompt).
* **Валидация JSON** от LLM + «repair pass» (один ретрай).
* **Presigned URL** для аудио к провайдеру → без проксирования тяжёлых файлов через backend.
* **Схема критериев** на уровне вопроса → честное взвешивание и must-have без «магии».
* **Идempotency-keys** для вебхуков (защита от дублей).
* **Профили конфиденциальности**: флагом отключать паралингвистику при необходимости.
* **Снижение задержки**: подготавливать следующий вопрос (TTS) параллельно с оценкой текущего ответа.

---

# 7) Критические замечания и как их закрываем

* **Эмоции и «тон» легко переинтерпретировать** → используем как **вспомогательные** признаки, по умолчанию **не влияют** на итог без явной настройки HR.
* **Телефонное качество (8 кГц, шум)** → фильтр шума, VAD, настройка порога, тесты на эталонах (WER-цель ≤ 15–18% для ru narrowband).
* **Справедливость и предвзятость** → не используем тембр/пол/акцент в скоринге; показываем объяснения и цитаты; храним критерии/веса прозрачно.
* **Зависимость от LLM** → строгие схемы JSON, ретраи, fallback-ответ «не смог оценить» с меткой.
* **Срыв звонка/сетевые лаги** → «продолжить с того места», финальный safe-outro; статус `interrupted` в сессии.
* **152-ФЗ/PII** → голос/ФИО/контакты — отдельный vault, ограниченные TTL на аудио, явное голосовое согласие в интро.

---

# 8) Модель данных (укороченно, как ориентир)

* `candidates(id, fio, contacts)`
* `vacancies(id, title, description)`
* `questions(id, text, type, max_duration_s)`
* `vacancy_questions(vacancy_id, question_id, step_no, question_weight, must_have)`
* `criteria(id, code, name)`
* `question_criteria(question_id, criterion_id, weight, must_have, min_score)`
* `sessions(id, candidate_id, vacancy_id, status, started_at, finished_at, total_score)`
* `qa(id, session_id, step_no, question_id, question_text, answer_text, audio_url, tone, passed)`
* `qa_scores(id, qa_id, criterion_id, score, evidence, red_flag)`
* `media(id, session_id, kind, url, duration_ms)`

---

# 9) Эндпоинты Orchestrator (FastAPI)

* `POST /webhooks/call` — события провайдера (start/answer/end/record\_ready).
* `POST /orchestrator/next` — отдать следующий вопрос (URL аудио).
* `POST /processing/stt` — принять аудио, вернуть транскрипт + сегменты.
* `POST /processing/score` — вызвать LLM-оценку (по контракту выше).
* `GET /hr/sessions` — список с фильтрами.
* `GET /hr/sessions/{id}` — карточка сессии.
* `POST /hr/qa/{id}/review` — ручная переоценка.

Все POST — idempotent (заголовок `Idempotency-Key`), ответы — с `request_id`.

---

# 10) Качество, метрики, тест-набор

**Метрики:**

* Latency: STT/LLM/TTS/общий end-to-report.
* Точность: сходимость с ручной оценкой HR на 20+ примерах (Δ ≤ 15%).
* VAD-ошибки: доля досрочного обрыва/лишнего ожидания < 5%.
* Устойчивость: ≥ 99% успешных шагов без ретрая на демо.

**Тест-набор:**

* 10–15 аудио-заготовок (м/ж, разные темпы, шум).
* Скрипт «симулятор провайдера» (HTTP) + фиктивные аудио для проверки без реальной телефонии.
* Юнит-тесты: валидация контрактов JSON, агрегация скоров, ранний фейл.

---

# 11) Безопасность и соответствие

* Голосовое **согласие на запись** в интро.
* Маскирование телефонов/e-mail в логах.
* TTL аудио (напр., 30 дней), удаление по кнопке.
* RBAC: роль **HR** и роль **Admin** в панели.
* Шифрование ссылок на аудио (presigned, 15 мин).

---

# 12) План работ (этапы и приёмка)

**Этап 1. Интеграция с провайдером (0.5–1 дн.)**
Webhook, воспроизведение аудио-URL, запись ответа. *Приёмка:* тестовый звонок проигрывает TTS-интро, пишет ответ.

**Этап 2. STT+VAD (1 дн.)**
Обработка аудио, конец ответа по паузе/таймауту. *Приёмка:* ≥ 90% ответов корректно отсекаются на тест-наборе.

**Этап 3. LLM-оценка по критериям (1 дн.)**
Схема JSON, валидация, ретрай. *Приёмка:* валидный JSON на 100% вызовов.

**Этап 4. Админка (1–1.5 дн.)**
Список сессий, карточка, «роза ветров», переоценка. *Приёмка:* просмотр ≥ 1 завершённой сессии от звонка до отчёта.

**Этап 5. Полировка и наблюдаемость (0.5 дн.)**
Логи, Sentry, метрики, экспорт отчёта. *Приёмка:* демо-скрипт «звонок → отчёт» ≤ 1–2 мин.

---

# 13) Definition of Done (MVP)

* Реальный звонок проведён end-to-end, результаты видны в панели.
* Поведение при обрыве/тишине корректно.
* LLM отвечает строго по схеме; логируются объяснения и цитаты.
* Веса/критерии на уровне вопроса; must-have работает.
* Документация: README (запуск), .env.sample, пример сценария и критериев в JSON/CSV.

---

# 14) Как запустить проект

## Предварительные требования

* Docker и Docker Compose
* Git

## Быстрый старт

1. **Клонируйте репозиторий:**
   ```bash
   git clone <repository-url>
   cd more.tech.2025
   ```

2. **Скопируйте файл с переменными окружения:**
   ```bash
   cp env.sample .env
   # Отредактируйте .env файл, добавив ваши API ключи
   ```

3. **Запустите все сервисы:**
   ```bash
   make up
   ```

4. **Проверьте статус сервисов:**
   ```bash
   make health
   ```

5. **Загрузите демо-данные:**
   ```bash
   make seed
   ```

6. **Откройте приложение:**
   - Frontend: http://localhost:3000
   - API документация: http://localhost:8000/docs
   - MinIO консоль: http://localhost:9001

## Полезные команды

```bash
# Управление сервисами
make up          # Запустить все сервисы
make down        # Остановить все сервисы
make build       # Пересобрать образы
make logs        # Показать логи всех сервисов

# База данных
make db-migrate  # Применить миграции
make db-reset    # Сбросить базу данных
make db-status   # Статус миграций

# Разработка
make test        # Запустить тесты
make lint        # Проверить код
make clean       # Очистить все контейнеры и образы

# Демо и тестирование
make demo        # Запустить демо-скрипт
make seed        # Загрузить демо-данные
make test-sip    # Тестировать SIP симулятор
make test-interview # Тестировать полное интервью
make demo-full   # Запустить полный демо системы


## Структура проекта

```
more.tech.2025/
├── docker-compose.yml      # Конфигурация всех сервисов
├── Makefile               # Команды для управления
├── env.sample             # Пример переменных окружения
├── migrations/            # SQL миграции
├── seeds/                 # Демо-данные
├── orchestrator/          # Основной сервис (FastAPI)
├── stt/                   # Speech-to-Text сервис
├── tts/                   # Text-to-Speech сервис
├── scoring/               # LLM-оценка сервис
└── frontend/              # Vue.js фронтенд
```

## Проверка работоспособности

После запуска проверьте:

1. **Health checks всех сервисов:**
   ```bash
   curl http://localhost:8000/healthz  # Orchestrator
   curl http://localhost:8001/healthz  # STT
   curl http://localhost:8002/healthz  # TTS
   curl http://localhost:8003/healthz  # Scoring
   curl http://localhost:3000          # Frontend
   ```

2. **Демо-данные в базе:**
   ```bash
   make shell-db
   # В psql:
   SELECT * FROM candidates;
   SELECT * FROM sessions;
   ```

3. **API документация:**
   - Откройте http://localhost:8000/docs
   - Протестируйте эндпоинты

---
